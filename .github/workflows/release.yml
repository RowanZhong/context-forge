# Context Forge å‘å¸ƒæµæ°´çº¿
# è§¦å‘æ¡ä»¶ï¼šåˆ›å»º v* æ ‡ç­¾
# ä»»åŠ¡ï¼šç‰ˆæœ¬éªŒè¯ / Docker æ„å»ºæ¨é€ / GitHub Release

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼šv0.1.0ï¼‰'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===== ç‰ˆæœ¬éªŒè¯ =====
  validate:
    name: éªŒè¯ç‰ˆæœ¬å·
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      version: ${{ steps.get_version.outputs.version }}
      version_without_v: ${{ steps.get_version.outputs.version_without_v }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          VERSION_WITHOUT_V="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_without_v=$VERSION_WITHOUT_V" >> $GITHUB_OUTPUT
          echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"

      - name: éªŒè¯ç‰ˆæœ¬æ ¼å¼
        run: |
          VERSION="${{ steps.get_version.outputs.version_without_v }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "é”™è¯¯ï¼šç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®ï¼ˆåº”ä¸º x.y.zï¼‰"
            exit 1
          fi

      - name: éªŒè¯ pyproject.toml ç‰ˆæœ¬ä¸€è‡´æ€§
        run: |
          PYPROJECT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          TAG_VERSION="${{ steps.get_version.outputs.version_without_v }}"
          if [[ "$PYPROJECT_VERSION" != "$TAG_VERSION" ]]; then
            echo "é”™è¯¯ï¼špyproject.toml ç‰ˆæœ¬ ($PYPROJECT_VERSION) ä¸æ ‡ç­¾ç‰ˆæœ¬ ($TAG_VERSION) ä¸ä¸€è‡´"
            exit 1
          fi
          echo "ç‰ˆæœ¬éªŒè¯é€šè¿‡ï¼š$TAG_VERSION"

      - name: éªŒè¯ CHANGELOG.md åŒ…å«æ­¤ç‰ˆæœ¬
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if ! grep -q "\[$VERSION\]" CHANGELOG.md; then
            echo "è­¦å‘Šï¼šCHANGELOG.md ä¸­æœªæ‰¾åˆ° $VERSION çš„æ›´æ–°æ—¥å¿—"
          fi

  # ===== æ„å»ºå’Œå‘å¸ƒ Docker é•œåƒ =====
  docker:
    name: æ„å»ºå’Œæ¨é€ Docker é•œåƒ
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [validate]

    permissions:
      contents: read
      packages: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ç™»å½• Docker Hubï¼ˆå¯é€‰ï¼‰
        if: secrets.DOCKERHUB_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
            context-forge/context-forge
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.validate.outputs.version_without_v }}

      - name: éªŒè¯é•œåƒ
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.version_without_v }}
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.version_without_v }} \
            python -c "from context_forge import ContextForge; print('Image validated successfully')"

  # ===== åˆ›å»º GitHub Release =====
  release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate, docker]

    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: å®‰è£…æ„å»ºå·¥å…·
        run: pip install build

      - name: æ„å»ºåˆ†å‘åŒ…
        run: python -m build

      - name: æå–ç‰ˆæœ¬æ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          # ä» CHANGELOG.md æå–æ­¤ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
          CHANGELOG=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' | tail -n +2)
          if [[ -z "$CHANGELOG" ]]; then
            CHANGELOG="å‘å¸ƒç‰ˆæœ¬ $VERSION"
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆ Release è¯´æ˜
        id: release_notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          cat > release_notes.md << EOF
          ## Context Forge $VERSION

          **é«˜æ€§èƒ½åŠ¨æ€ä¸Šä¸‹æ–‡ç»„è£…å¼•æ“** â€” LLM åº”ç”¨çš„ ORM

          ### æœ¬æ¬¡å‘å¸ƒ

          ${{ steps.changelog.outputs.CHANGELOG }}

          ### å®‰è£…

          \`\`\`bash
          # PyPI å®‰è£…
          pip install context-forge==${{ needs.validate.outputs.version_without_v }}

          # Docker å®‰è£…
          docker pull ghcr.io/${{ github.repository }}:${{ needs.validate.outputs.version_without_v }}
          \`\`\`

          ### å¿«é€Ÿä¸Šæ‰‹

          \`\`\`python
          from context_forge import ContextForge

          forge = ContextForge(model="gpt-4o")
          context = await forge.build(
              system_prompt="ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹ã€‚",
              messages=[{"role": "user", "content": "ä½ å¥½"}],
          )
          \`\`\`

          ### Docker è¿è¡Œ

          \`\`\`bash
          docker run -p 8000:8000 ghcr.io/${{ github.repository }}:${{ needs.validate.outputs.version_without_v }}
          \`\`\`

          ### æ–‡æ¡£

          - ğŸ“š [å®Œæ•´æ–‡æ¡£](https://context-forge.github.io)
          - ğŸš€ [å¿«é€Ÿä¸Šæ‰‹](https://github.com/${{ github.repository }}/blob/main/README.md)
          - ğŸ—ï¸ [æ¶æ„è®¾è®¡](https://github.com/${{ github.repository }}/blob/main/docs/architecture.md)
          - ğŸ“– [API å‚è€ƒ](https://github.com/${{ github.repository }}/blob/main/docs/api_reference.md)

          ### æ”¯æŒ

          - [æŠ¥å‘Šé—®é¢˜](https://github.com/${{ github.repository }}/issues)
          - [è´¡çŒ®æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md)
          EOF

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: Context Forge ${{ needs.validate.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
          files: |
            dist/*
          generate_release_notes: true

  # ===== å‘å¸ƒåé€šçŸ¥ï¼ˆå¯é€‰ï¼‰=====
  notify:
    name: å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate, docker, release]
    if: always()

    steps:
      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… Context Forge ${{ needs.validate.outputs.version }} å‘å¸ƒæˆåŠŸï¼"
          echo "PyPI: https://pypi.org/project/context-forge/${{ needs.validate.outputs.version_without_v }}"
          echo "Docker: ghcr.io/${{ github.repository }}:${{ needs.validate.outputs.version_without_v }}"
          echo "Release: https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate.outputs.version }}"

      - name: å‘å¸ƒå¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ Context Forge ${{ needs.validate.outputs.version }} å‘å¸ƒå¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æµæ°´çº¿æ—¥å¿—ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
