# Context Forge Docker Compose 配置
# 服务编排：Context Forge + Redis

version: '3.8'

services:
  # ===== Context Forge 主服务 =====
  context-forge:
    build:
      context: .
      dockerfile: Dockerfile
    image: context-forge:latest
    container_name: context-forge
    hostname: context-forge
    restart: unless-stopped

    ports:
      - "8000:8000"

    environment:
      # Context Forge 配置
      - CONTEXT_FORGE_LOG_LEVEL=INFO
      - CONTEXT_FORGE_ENABLE_CACHE=true
      - CONTEXT_FORGE_CACHE_TTL=3600
      - CONTEXT_FORGE_ENABLE_OBSERVABILITY=false
      - CONTEXT_FORGE_SERVER_HOST=0.0.0.0
      - CONTEXT_FORGE_SERVER_PORT=8000

      # Redis 连接
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_URL=redis://redis:6379/0

      # 可观测性（可选）
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=context-forge

    volumes:
      # 数据持久化
      - context-forge-data:/data
      - context-forge-cache:/cache

      # 配置文件挂载（可选，覆盖默认配置）
      # - ./configs/production_policy.yaml:/app/configs/policy.yaml:ro

      # 日志输出（可选）
      # - ./logs:/app/logs

    depends_on:
      redis:
        condition: service_healthy

    networks:
      - context-forge-net

    healthcheck:
      test: ["CMD", "python", "-c", "from context_forge import ContextForge; print('OK')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ===== Redis 缓存服务 =====
  redis:
    image: redis:7-alpine
    container_name: context-forge-redis
    hostname: redis
    restart: unless-stopped

    ports:
      - "6379:6379"

    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru

    volumes:
      - redis-data:/data

    networks:
      - context-forge-net

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  # ===== Jaeger 分布式追踪（可选，用于开发调试）=====
  # 取消下面注释以启用 Jaeger
  # jaeger:
  #   image: jaegertracing/all-in-one:latest
  #   container_name: context-forge-jaeger
  #   hostname: jaeger
  #   restart: unless-stopped
  #
  #   ports:
  #     - "16686:16686"  # Jaeger UI
  #     - "4317:4317"    # OTLP gRPC
  #     - "4318:4318"    # OTLP HTTP
  #
  #   environment:
  #     - COLLECTOR_OTLP_ENABLED=true
  #
  #   networks:
  #     - context-forge-net

  # ===== Prometheus 指标收集（可选）=====
  # 取消下面注释以启用 Prometheus
  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: context-forge-prometheus
  #   hostname: prometheus
  #   restart: unless-stopped
  #
  #   ports:
  #     - "9090:9090"
  #
  #   volumes:
  #     - ./configs/prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #     - prometheus-data:/prometheus
  #
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #
  #   networks:
  #     - context-forge-net

# ===== 网络配置 =====
networks:
  context-forge-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ===== 数据卷 =====
volumes:
  context-forge-data:
    driver: local
  context-forge-cache:
    driver: local
  redis-data:
    driver: local
  # prometheus-data:
  #   driver: local

# ===== 使用说明 =====
# 启动所有服务：
#   docker-compose up -d
#
# 查看日志：
#   docker-compose logs -f context-forge
#
# 停止服务：
#   docker-compose down
#
# 停止并删除数据卷：
#   docker-compose down -v
#
# 重新构建镜像：
#   docker-compose build --no-cache
#
# 扩容 Context Forge 服务（负载均衡）：
#   docker-compose up -d --scale context-forge=3
#
# 访问服务：
#   Context Forge API: http://localhost:8000
#   Redis: localhost:6379
#   Jaeger UI: http://localhost:16686 (如果启用)
#   Prometheus UI: http://localhost:9090 (如果启用)
