# ============================================================
# 多 Agent 上下文协调策略
#
# 适用场景：多 Agent 协作、工作流编排、Agent 间通信
# 核心特性：命名空间隔离、状态锚点、Handoff 协议
#
# → 6.3.4 Isolate：命名空间与跨 Agent 上下文复用
# → 6.6 上下文路由与动态调度
# ============================================================

version: "1.0"
name: "multi_agent_coordination"
description: "多 Agent 协调策略 — 隔离与共享的平衡"

# --- 预算分配策略 ---
budget:
  # 每个 Agent 的预算：64K（中等窗口）
  max_context_tokens: 64000

  # Output 预留：Agent 通常需要结构化输出
  output_reserved_tokens: 4096

  # Thinking 预留：Agent 可能需要推理
  thinking_reserved_tokens: 0

  # 饱和度阈值
  saturation_threshold: 0.85

  # 溢出策略：压缩（保留关键信息）
  overflow_strategy: "compress"

  # 弹性区间配额：优先状态和工具结果
  elastic_ratios:
    state: 0.25             # 状态锚点（重要）
    tool_result: 0.20       # 工具结果（重要）
    user: 0.15              # 用户消息
    assistant: 0.15         # 助手回复
    rag: 0.15               # RAG 片段
    summary: 0.10           # 摘要

# --- 清洗策略 ---
sanitize:
  # 基础清洗
  unicode_normalize: true
  strip_html: true

  # PII 脱敏：谨慎启用（可能影响 Agent 间信息传递）
  pii_redaction: false

  # Injection 检测：启用（防止恶意 Agent）
  injection_detection: true
  on_injection: "warn_and_remove"

  # 单 Segment 最大字符数
  max_segment_chars: 10000

  # 最大重复字符数
  max_repeat_chars: 100

  # Injection 检测级别：启发式
  injection_level: "heuristic"

# --- 重排策略 ---
rerank:
  # MMR：避免重复内容
  enable_mmr: true

  # MMR 参数
  mmr_lambda: 0.7
  similarity_threshold: 0.85

  # 每种类型最大数量：state 不限制，其他限制
  max_per_type: 0

  # 时效性加权：优先最新状态
  enable_temporal_weighting: true
  temporal_decay_rate: 0.15
  temporal_min_weight: 0.30

# --- 压缩策略 ---
compress:
  # 启用压缩
  enabled: true

  # 默认压缩器：去重（Agent 间可能有重复信息）
  default_compressor: "dedup"

  # 触发压缩的饱和度阈值
  saturation_trigger: 0.85

  # 保护 must_keep 标记的 Segment（状态锚点）
  preserve_must_keep: true

  # 压缩后最小 Token 数
  min_segment_tokens: 50

# --- 缓存策略 ---
cache:
  # 启用缓存：Agent 间复用上下文
  enabled: true

  # 缓存后端：Redis（分布式 Agent 协作）
  # ⚠️ 单机场景可以使用 memory
  backend: "redis"

  # 前缀缓存：System Prompt + Tool Definition 复用
  prefix_cache: true

  # 语义缓存：不启用（Agent 间上下文精确匹配更重要）
  semantic_cache: false

  # 缓存过期时间：10 分钟（会话级别）
  ttl_seconds: 600

  # 最大缓存条目数：2000 个（多 Agent 需要更大容量）
  max_entries: 2000

  # Redis URL（需要配置）
  redis_url: "redis://localhost:6379/0"

# --- 路由策略 ---
routing:
  # 启用路由：根据任务类型分配 Agent
  enabled: true

  # 默认模型：GPT-4o
  default_model: "gpt-4o"

  # 路由器类型：规则路由（确定性）
  router_type: "rule_based"

  # 路由规则示例
  rules:
    # 简单任务 → 小模型
    - condition:
        complexity: "simple"
      target_model: "gpt-4o-mini"
      reason: "简单任务使用小模型"

    # 复杂推理 → 大模型
    - condition:
        complexity: "complex"
      target_model: "claude-sonnet-4-5"
      reason: "复杂推理使用 Claude Sonnet"

    # 编码任务 → 专用模型
    - condition:
        task_type: "code_generation"
      target_model: "gpt-4o"
      reason: "编码任务使用 GPT-4o"

    # 默认规则
    - condition:
        default: true
      target_model: "gpt-4o"
      reason: "默认模型"

# --- 可观测性 ---
observability:
  # 生成 Snapshot：便于调试 Agent 协作
  snapshot_enabled: true

  # 启用 Tracing：追踪 Agent 间调用链
  # ⚠️ 需要配置 OTEL_EXPORTER_OTLP_ENDPOINT
  tracing_enabled: true

  # 收集指标：监控 Agent 性能、Handoff 次数
  metrics_enabled: true

  # 导出格式：OTLP（与分布式追踪集成）
  export_format: "otlp"

  # Snapshot 存储目录
  snapshot_dir: ".context_forge/snapshots"

# --- 反模式检测 ---
antipattern:
  # 启用反模式检测
  enabled: true

  # 在每次 build 时自动检测（监控 Agent 行为）
  check_on_build: true

  # 不在检测到 CRITICAL 时抛出异常（避免阻塞 Agent 协作）
  fail_on_critical: false

  # 检测阈值
  critical_ratio_threshold: 0.5
  rigid_budget_threshold: 0.7
  compression_ratio_threshold: 0.10
  ttl_days_threshold: 1               # Agent 状态 1 天过期提示
  routing_effectiveness_threshold: 0.15  # 路由有效性阈值
