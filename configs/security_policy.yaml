# ============================================================
# å®‰å…¨åˆè§„æ¸…æ´—ç­–ç•¥
#
# é€‚ç”¨åœºæ™¯ï¼šé‡‘èã€åŒ»ç–—ã€æ”¿åŠ¡ç­‰é«˜åˆè§„è¦æ±‚åœºæ™¯
# æ ¸å¿ƒç‰¹æ€§ï¼šä¸¥æ ¼æ¸…æ´—ã€PII è„±æ•ã€Injection æ‹¦æˆªã€å®¡è®¡æ—¥å¿—
#
# â†’ 6.4 ä¸Šä¸‹æ–‡æ¸…æ´—ä¸é›¶ä¿¡ä»»å®‰å…¨
# â†’ 6.4.3 é›¶ä¿¡ä»»æ¸…æ´—ç®¡é“è®¾è®¡
# ============================================================

version: "1.0"
name: "security_compliance"
description: "å®‰å…¨åˆè§„ç­–ç•¥ â€” ä¸¥æ ¼æ¸…æ´—ä¸é›¶ä¿¡ä»»åŸåˆ™"

# --- é¢„ç®—åˆ†é…ç­–ç•¥ ---
budget:
  # æ ‡å‡†çª—å£
  max_context_tokens: 128000

  # Output é¢„ç•™
  output_reserved_tokens: 4096

  # Thinking é¢„ç•™
  thinking_reserved_tokens: 0

  # é¥±å’Œåº¦é˜ˆå€¼
  saturation_threshold: 0.85

  # æº¢å‡ºç­–ç•¥ï¼šæ‹’ç»è€Œéæˆªæ–­ï¼ˆä¿è¯å®Œæ•´æ€§ï¼‰
  overflow_strategy: "error"

  # å¼¹æ€§åŒºé—´é…é¢
  elastic_ratios:
    rag: 0.30
    user: 0.20
    assistant: 0.25
    few_shot: 0.15
    tool_result: 0.10

# --- æ¸…æ´—ç­–ç•¥ ---
sanitize:
  # === åŸºç¡€æ¸…æ´— ===

  # Unicode å½’ä¸€åŒ–ï¼šé˜²æ­¢ç¼–ç æ”»å‡»
  unicode_normalize: true

  # HTML å‰¥ç¦»ï¼šé˜²æ­¢ XSS
  strip_html: true

  # === PII è„±æ• ===

  # å¯ç”¨ PII è„±æ•ï¼šé«˜åˆè§„åœºæ™¯å¿…é¡»
  pii_redaction: true

  # éœ€è¦è„±æ•çš„ PII ç±»å‹ï¼ˆå…¨è¦†ç›–ï¼‰
  pii_patterns:
    - phone           # æ‰‹æœºå·ï¼ˆ138****8000ï¼‰
    - email           # é‚®ç®±ï¼ˆa***b@example.comï¼‰
    - id_card         # èº«ä»½è¯å·ï¼ˆ110101********1234ï¼‰
    - bank_card       # é“¶è¡Œå¡å·ï¼ˆ6225********1234ï¼‰
    - ip_address      # IP åœ°å€ï¼ˆ192.*.*.*ï¼‰
    - url             # URLï¼ˆ[REDACTED_URL]ï¼‰
    # ğŸ­ ç”Ÿäº§æç¤ºï¼šaddress / passport / ssn éœ€æ‰©å±• PIIType æšä¸¾åå¯ç”¨

  # === Injection æ£€æµ‹ ===

  # å¯ç”¨ Injection æ£€æµ‹
  injection_detection: true

  # Injection æ£€æµ‹åçš„å¤„ç†ç­–ç•¥ï¼šç›´æ¥æ‹’ç»ï¼ˆerror æ¨¡å¼ï¼‰
  # âš ï¸ å®‰å…¨åœºæ™¯ä¸èƒ½å®¹å¿ä»»ä½•æ½œåœ¨æ”»å‡»ï¼Œå¿…é¡»æ‹’ç»
  on_injection: "error"

  # Injection æ£€æµ‹çº§åˆ«ï¼šåˆ†ç±»å™¨ï¼ˆæ›´å‡†ç¡®ï¼Œéœ€è¦ LLMï¼‰
  # å¦‚æ—  LLM å¯ç”¨ï¼Œè‡ªåŠ¨é™çº§åˆ° heuristic
  injection_level: "classifier"

  # Injection æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼ï¼š0.5ï¼ˆæ›´ä¸¥æ ¼ï¼‰
  injection_confidence_threshold: 0.5

  # === é•¿åº¦é˜²æŠ¤ ===

  # å• Segment æœ€å¤§å­—ç¬¦æ•°ï¼šé˜²æ­¢ DoS æ”»å‡»
  max_segment_chars: 20000

  # æœ€å¤§é‡å¤å­—ç¬¦æ•°ï¼šé˜²æ­¢é‡å¤æ”»å‡»
  max_repeat_chars: 50

# --- é‡æ’ç­–ç•¥ ---
rerank:
  # MMRï¼šé¿å…é‡å¤å†…å®¹ï¼ˆå‡å°‘æ”»å‡»é¢ï¼‰
  enable_mmr: true

  # MMR å‚æ•°
  mmr_lambda: 0.7
  similarity_threshold: 0.85

  # æ¯ç§ç±»å‹æœ€å¤§æ•°é‡ï¼šé™åˆ¶å•ä¸€æ¥æºå æ¯”
  max_per_type: 15

  # æ—¶æ•ˆæ€§åŠ æƒï¼šä¼˜å…ˆæœ€æ–°æ•°æ®
  enable_temporal_weighting: true
  temporal_decay_rate: 0.10
  temporal_min_weight: 0.30

# --- å‹ç¼©ç­–ç•¥ ---
compress:
  # å¯ç”¨å‹ç¼©
  enabled: true

  # é»˜è®¤å‹ç¼©å™¨ï¼šæˆªæ–­ï¼ˆä¸éœ€è¦ LLMï¼Œå®‰å…¨ï¼‰
  # âš ï¸ å®‰å…¨åœºæ™¯é¿å…ä½¿ç”¨ LLM å‹ç¼©ï¼ˆå¯èƒ½å¼•å…¥ä¸å¯æ§å†…å®¹ï¼‰
  default_compressor: "truncation"

  # è§¦å‘å‹ç¼©çš„é¥±å’Œåº¦é˜ˆå€¼
  saturation_trigger: 0.85

  # ä¿æŠ¤ must_keep æ ‡è®°çš„ Segment
  preserve_must_keep: true

  # å‹ç¼©åæœ€å° Token æ•°
  min_segment_tokens: 50

# --- ç¼“å­˜ç­–ç•¥ ---
cache:
  # ç¼“å­˜ï¼šè°¨æ…å¯ç”¨ï¼ˆå¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯ï¼‰
  # âš ï¸ å¦‚å¯ç”¨ï¼Œå¿…é¡»ä½¿ç”¨åŠ å¯†ç¼“å­˜åç«¯
  enabled: false

  # ç¼“å­˜åç«¯ï¼šå†…å­˜ï¼ˆä¸æŒä¹…åŒ–ï¼‰
  backend: "memory"

  # å‰ç¼€ç¼“å­˜ï¼šSystem Prompt å¯ä»¥ç¼“å­˜
  prefix_cache: true

  # è¯­ä¹‰ç¼“å­˜ï¼šç¦ç”¨ï¼ˆé¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼‰
  semantic_cache: false

  # ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼š5 åˆ†é’Ÿï¼ˆçŸ­æœŸï¼‰
  ttl_seconds: 300

  # æœ€å¤§ç¼“å­˜æ¡ç›®æ•°ï¼š100 ä¸ª
  max_entries: 100

# --- è·¯ç”±ç­–ç•¥ ---
routing:
  # è·¯ç”±ï¼šç¦ç”¨ï¼ˆå•ä¸€æ¨¡å‹ä¾¿äºå®¡è®¡ï¼‰
  enabled: false

  # é»˜è®¤æ¨¡å‹ï¼šGPT-4o
  default_model: "gpt-4o"

# --- å¯è§‚æµ‹æ€§ ---
observability:
  # ç”Ÿæˆ Snapshotï¼šå¿…é¡»ï¼ˆåˆè§„å®¡è®¡è¦æ±‚ï¼‰
  snapshot_enabled: true

  # å¯ç”¨ Tracingï¼šå¿…é¡»ï¼ˆè¿½è¸ªæ¯æ¬¡å¤„ç†ï¼‰
  # âš ï¸ éœ€è¦é…ç½® OTEL_EXPORTER_OTLP_ENDPOINT
  tracing_enabled: true

  # æ”¶é›†æŒ‡æ ‡ï¼šå¿…é¡»ï¼ˆç›‘æ§å¼‚å¸¸è¡Œä¸ºï¼‰
  metrics_enabled: true

  # å¯¼å‡ºæ ¼å¼ï¼šOTLPï¼ˆæ ‡å‡†åŒ–ï¼‰
  export_format: "otlp"

  # Snapshot å­˜å‚¨ç›®å½•ï¼ˆå¿…é¡»å®šæœŸå½’æ¡£ï¼‰
  snapshot_dir: ".context_forge/snapshots"

# --- åæ¨¡å¼æ£€æµ‹ ---
antipattern:
  # å¯ç”¨åæ¨¡å¼æ£€æµ‹
  enabled: true

  # åœ¨æ¯æ¬¡ build æ—¶è‡ªåŠ¨æ£€æµ‹ï¼ˆå®‰å…¨åœºæ™¯å¿…é¡»ï¼‰
  check_on_build: true

  # æ£€æµ‹åˆ° CRITICAL çº§åˆ«åæ¨¡å¼æ—¶æŠ›å‡ºå¼‚å¸¸
  fail_on_critical: true

  # æ£€æµ‹é˜ˆå€¼ï¼ˆæ›´ä¸¥æ ¼ï¼‰
  critical_ratio_threshold: 0.3       # CRITICAL å æ¯” > 30% æŠ¥è­¦
  rigid_budget_threshold: 0.6         # åˆšæ€§é¢„ç®— > 60% æŠ¥è­¦
  compression_ratio_threshold: 0.10   # å‹ç¼©ç‡ < 10% æŠ¥è­¦ï¼ˆé¿å…è¿‡åº¦å‹ç¼©ï¼‰
  ttl_days_threshold: 7               # TTL > 7 å¤©æŠ¥è­¦ï¼ˆæ•°æ®æ—¶æ•ˆæ€§ï¼‰
